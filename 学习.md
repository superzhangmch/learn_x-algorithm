## QUERY HYDRATION é˜¶æ®µ

  INPUTï¼ˆæ°´åˆå‰ï¼‰
```
  ScoredPostsQuery {
      // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
      user_id: 123456789,
      client_app_id: 258901,  // iOS/Android app identifier

      // è¯·æ±‚ä¸Šä¸‹æ–‡
      country_code: "US",
      language_code: "en",
      request_id: "abc123xyz-123456789",

      // å·²çœ‹è¿‡å’Œå·²æœåŠ¡çš„æ¨æ–‡ID
      seen_ids: vec![9001234567890, 9001234567891],
      served_ids: vec![9001234567892],

      // è¯·æ±‚å‚æ•°
      in_network_only: false,        // false = For You, true = Following
      is_bottom_request: false,      // æ˜¯å¦æ˜¯æ»šåŠ¨åˆ°åº•éƒ¨çš„è¯·æ±‚
      bloom_filter_entries: vec![],  // å»é‡ç”¨çš„å¸ƒéš†è¿‡æ»¤å™¨

      // ğŸ”´ æ°´åˆå‰è¿™ä¸¤ä¸ªå­—æ®µæ˜¯ç©ºçš„
      user_action_sequence: None,
      user_features: UserFeatures::default(),  // ç©ºçš„é»˜è®¤å€¼
  }
```

  OUTPUTï¼ˆæ°´åˆåï¼‰
```
  ScoredPostsQuery {
      // åŸºæœ¬ä¿¡æ¯ä¿æŒä¸å˜
      user_id: 123456789,
      client_app_id: 258901,
      country_code: "US",
      language_code: "en",
      request_id: "abc123xyz-123456789",
      seen_ids: vec![9001234567890, 9001234567891],
      served_ids: vec![9001234567892],
      in_network_only: false,
      is_bottom_request: false,
      bloom_filter_entries: vec![],

      // ğŸŸ¢ æ°´åˆåå¡«å……äº†ç”¨æˆ·è¡Œä¸ºåºåˆ—
      user_action_sequence: Some(UserActionSequence {
          user_id: 123456789,

          // å…ƒæ•°æ®
          metadata: Some(UserActionSequenceMeta {
              length: 50,                        // åºåˆ—ä¸­æœ‰50ä¸ªèšåˆè¡Œä¸º
              first_sequence_time: 1737360000000, // 2026-01-20 æœ€æ—©è¡Œä¸ºæ—¶é—´æˆ³
              last_sequence_time: 1737446400000,  // 2026-01-21 æœ€è¿‘è¡Œä¸ºæ—¶é—´æˆ³
              last_modified_epoch_ms: 1737446410000,
              previous_kafka_publish_epoch_ms: 1737446405000,
          }),

          // ç”¨æˆ·çš„èšåˆè¡Œä¸ºåˆ—è¡¨ï¼ˆæœ€è¿‘50ä¸ªè¡Œä¸ºï¼‰
          user_actions_data: Some(UserActionSequenceDataContainer {
              data: Some(OrderedAggregatedUserActionsList(
                  AggregatedUserActionList {
                      aggregation_provider: "DefaultAggregator",
                      aggregation_time_ms: 1737446420000,

                      // å…·ä½“çš„è¡Œä¸ºåºåˆ—ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
                      aggregated_user_actions: vec![
                          // è¡Œä¸º1: ç‚¹èµäº†ä¸€æ¡æ¨æ–‡
                          AggregatedUserAction {
                              action_type: Like,
                              tweet_id: 9001234567800,
                              author_id: 987654321,
                              impressed_time_ms: 1737360120000,  // è¡Œä¸ºå‘ç”Ÿæ—¶é—´
                              engaged_time_ms: 1737360125000,    // å®é™…ç‚¹å‡»æ—¶é—´
                              action_count: 1,
                          },

                          // è¡Œä¸º2: å›å¤äº†ä¸€æ¡æ¨æ–‡
                          AggregatedUserAction {
                              action_type: Reply,
                              tweet_id: 9001234567801,
                              author_id: 111222333,
                              impressed_time_ms: 1737360200000,
                              engaged_time_ms: 1737360245000,
                              action_count: 1,
                          },

                          // è¡Œä¸º3: è½¬å‘äº†ä¸€æ¡æ¨æ–‡
                          AggregatedUserAction {
                              action_type: Repost,
                              tweet_id: 9001234567802,
                              author_id: 444555666,
                              impressed_time_ms: 1737360300000,
                              engaged_time_ms: 1737360310000,
                              action_count: 1,
                          },

                          // è¡Œä¸º4: ç‚¹å‡»æŸ¥çœ‹äº†è¯¦æƒ…
                          AggregatedUserAction {
                              action_type: DetailExpand,
                              tweet_id: 9001234567803,
                              author_id: 777888999,
                              impressed_time_ms: 1737360400000,
                              engaged_time_ms: 1737360405000,
                              action_count: 1,
                          },

                          // è¡Œä¸º5: è®¿é—®äº†æŸä¸ªç”¨æˆ·ä¸»é¡µ
                          AggregatedUserAction {
                              action_type: ProfileVisit,
                              author_id: 123123123,
                              impressed_time_ms: 1737360500000,
                              engaged_time_ms: 1737360505000,
                              action_count: 1,
                          },

                          // ... è¿˜æœ‰45ä¸ªç±»ä¼¼çš„è¡Œä¸ºè®°å½•
                      ],
                  }
              )),
          }),

          masks: vec![
              Mask {
                  mask_type: NewEvent,
                  mask: vec![false; 50],  // 50ä¸ª falseï¼Œæ ‡è®°å“ªäº›æ˜¯æ–°äº‹ä»¶
              }
          ],
      }),

      // ğŸŸ¢ æ°´åˆåå¡«å……äº†ç”¨æˆ·ç‰¹å¾
      user_features: UserFeatures {
          // é™éŸ³çš„å…³é”®è¯åˆ—è¡¨
          muted_keywords: vec![
              "crypto".to_string(),
              "NFT".to_string(),
              "æŠ•ç¥¨".to_string(),
          ],

          // å±è”½çš„ç”¨æˆ·IDåˆ—è¡¨
          blocked_user_ids: vec![
              999888777,
              666555444,
          ],

          // é™éŸ³çš„ç”¨æˆ·IDåˆ—è¡¨
          muted_user_ids: vec![
              333222111,
          ],

          // å…³æ³¨çš„ç”¨æˆ·IDåˆ—è¡¨ï¼ˆæœ€å¤š1000ä¸ªï¼‰
          followed_user_ids: vec![
              111111111,
              222222222,
              333333333,
              444444444,
              // ... å¯èƒ½æœ‰å‡ ç™¾ä¸ª
          ],

          // è®¢é˜…çš„ç”¨æˆ·IDåˆ—è¡¨ï¼ˆTwitter Blue è®¢é˜…ï¼‰
          subscribed_user_ids: vec![
              555555555,
              666666666,
          ],
      },
  }
```
  å…³é”®å˜åŒ–æ€»ç»“
```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         å­—æ®µ         â”‚   æ°´åˆå‰   â”‚          æ°´åˆå          â”‚                   æ•°æ®æ¥æº                   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ user_action_sequence â”‚ None       â”‚ åŒ…å«50ä¸ªæœ€è¿‘è¡Œä¸ºè®°å½•     â”‚ UserActionSeqQueryHydrator ä» UAS æœåŠ¡è·å–   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ user_features        â”‚ ç©ºçš„é»˜è®¤å€¼ â”‚ åŒ…å«å…³æ³¨åˆ—è¡¨ã€å±è”½åˆ—è¡¨ç­‰ â”‚ UserFeaturesQueryHydrator ä» Strato æœåŠ¡è·å– â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 ```

  è¡Œä¸ºç±»å‹ç¤ºä¾‹

  æ ¹æ®ä»£ç å¼•ç”¨ï¼Œuser_action_sequence ä¸­å¯èƒ½åŒ…å«çš„è¡Œä¸ºç±»å‹ï¼š

  - Like: ç‚¹èµ
  - Reply: å›å¤
  - Repost: è½¬å‘
  - DetailExpand: ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
  - ProfileVisit: è®¿é—®ç”¨æˆ·ä¸»é¡µ
  - VideoView: è§‚çœ‹è§†é¢‘
  - PhotoExpand: æŸ¥çœ‹å›¾ç‰‡
  - LinkClick: ç‚¹å‡»é“¾æ¥
  - Follow: å…³æ³¨
  - Block: å±è”½
  - Mute: é™éŸ³
  - Report: ä¸¾æŠ¥
  - Share: åˆ†äº«


## å¬å›é˜¶æ®µ:
```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   ç»´åº¦   â”‚             THUNDER             â”‚        PHOENIX RETRIEVAL         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å¬å›æ–¹å¼ â”‚ åŸºäºå…³æ³¨å…³ç³»çš„ç´¢å¼•æŸ¥è¯¢          â”‚ åŸºäº embedding çš„ç›¸ä¼¼åº¦æœç´¢      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ æ•°æ®ç»“æ„ â”‚ å†…å­˜ HashMapï¼ˆuser_id â†’ postsï¼‰ â”‚ Vector Indexï¼ˆANNï¼‰              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ è¾“å…¥     â”‚ followed_user_idsï¼ˆå…³æ³¨åˆ—è¡¨ï¼‰   â”‚ user_action_sequenceï¼ˆè¡Œä¸ºå†å²ï¼‰ â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ç®—æ³•     â”‚ ç›´æ¥æŸ¥è¡¨ + æ—¶é—´æ’åº             â”‚ Two-Tower + Dot Product          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ é€Ÿåº¦     â”‚ æå¿«ï¼ˆ< 1msï¼‰                   â”‚ å¿«ï¼ˆ~10msï¼‰                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å¬å›èŒƒå›´ â”‚ In-Networkï¼ˆå…³æ³¨çš„äººï¼‰          â”‚ Out-of-Networkï¼ˆå…¨ç½‘ï¼‰           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ æ–°é²œåº¦   â”‚ å®æ—¶ï¼ˆKafka æµï¼‰                â”‚ ä¾èµ– embedding æ›´æ–°é¢‘ç‡          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ å¤šæ ·æ€§   â”‚ ä½ï¼ˆåªçœ‹å…³æ³¨çš„äººï¼‰              â”‚ é«˜ï¼ˆå‘ç°æ–°å†…å®¹ï¼‰                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ä»£ç ä½ç½® â”‚ thunder_source.rs:19-73         â”‚ phoenix_source.rs:15-51          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

THUNDER è¾“å…¥è¾“å‡º
```
  è¾“å…¥ï¼š
  {
    "user_id": 123456789,
    "following_user_ids": [111, 222, 333, 444, 555]  // å…³æ³¨äº†5ä¸ªäºº
  }

  è¾“å‡ºï¼š
  {
    "posts": [
      {"tweet_id": 9001, "author_id": 111, "created_at": 1737446400, "text": "..."},
      {"tweet_id": 9002, "author_id": 222, "created_at": 1737446300, "text": "..."},
      {"tweet_id": 9003, "author_id": 333, "created_at": 1737446200, "text": "..."},
      // ... æœ€å¤šè¿”å›å‡ ç™¾æ¡æ¥è‡ªå…³æ³¨ç”¨æˆ·çš„æ¨æ–‡
    ]
  }
```
  PHOENIX RETRIEVAL è¾“å…¥è¾“å‡º
```
  è¾“å…¥ï¼š
  {
    "user_id": 123456789,
    "user_action_sequence": {
      "actions": [
        {"type": "Like", "tweet_id": 8001, "author_id": 999, "topic": "AI"},
        {"type": "Reply", "tweet_id": 8002, "author_id": 888, "topic": "Tech"},
        {"type": "Repost", "tweet_id": 8003, "author_id": 777, "topic": "ML"}
      ]
    }
  }

  è¾“å‡ºï¼š
  {
    "top_k_candidates": [
      {"tweet_id": 7001, "author_id": 666, "similarity": 0.92, "topic": "AI"},  // æœªå…³æ³¨
      {"tweet_id": 7002, "author_id": 555, "similarity": 0.89, "topic": "ML"},  // æœªå…³æ³¨
      {"tweet_id": 7003, "author_id": 444, "similarity": 0.87, "topic": "Tech"} // æœªå…³æ³¨
      // ... åŸºäºå…´è¶£ç›¸ä¼¼åº¦å¬å›çš„æ¨æ–‡
    ]
  }
```


### 1ï¸âƒ£ User Towerï¼ˆç”¨æˆ·å¡”ï¼‰- Transformer

  ä»£ç ä½ç½®: recsys_retrieval_model.py:206-276

  æ¨¡å‹ç±»å‹: Grok-1 Transformerï¼ˆæ¥è‡ª xAI çš„ Grok-1 å¼€æºæ¨¡å‹ï¼‰

  æ¶æ„ç»†èŠ‚ï¼ˆgrok.py + run_retrieval.py:52-61ï¼‰:

```
  TransformerConfig(
      emb_size=128,              # embedding ç»´åº¦
      num_layers=2,              # Transformer å±‚æ•°ï¼ˆå®é™…ç”Ÿäº§ä¸­æ›´å¤šï¼‰
      num_q_heads=2,             # Query å¤´æ•°
      num_kv_heads=2,            # Key/Value å¤´æ•°
      key_size=64,               # æ¯ä¸ª attention head çš„ç»´åº¦
      widening_factor=2,         # FFN ä¸­é—´å±‚æ‰©å±•å€æ•°
      attn_output_multiplier=0.125,  # Attention è¾“å‡ºç¼©æ”¾
  )
```

  æ ¸å¿ƒç»„ä»¶:
  - Multi-Head Attention (MHA) with Grouped Query Attention (GQA)
  - RMSNorm (Root Mean Square Layer Normalization)
  - RoPE (Rotary Position Embeddings) - ä½ç½®ç¼–ç 
  - SwiGLU FFN - å‰é¦ˆç½‘ç»œä½¿ç”¨ SiLU/GeLU æ¿€æ´»å‡½æ•°
  - Hash-based Embeddings - ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°çš„ embedding

  è¾“å…¥ (recsys_retrieval_model.py:236-256):
```
  # ç”¨æˆ·ç‰¹å¾ embedding + å†å²è¡Œä¸º embeddings
  embeddings = concat([
      user_embeddings,           # [B, 1, D], B=batch_size, ä¸€å¤„å¤„ç†å¤šä¸ªç”¨æˆ·çš„è¯·æ±‚.
      history_embeddings,        # [B, S, D] - åŒ…å« post + author + actions
                                 # ä»¥ä¸Š 1, Sçš„å«ä¹‰: ä¸€ä¸ªç”¨æˆ·, ç¼–ç æˆä¸€ä¸ª dim=D çš„å‘é‡, ä¸€ä¸ª user action, ä¹Ÿæ˜¯ç¼–ç æˆä¸€ä¸ª dim=D çš„å‘é‡. ä¹Ÿå°±æ˜¯ç”¨æˆ·ä¸ action éƒ½æ˜¯å½“ä½œä¸€ä¸ªtokenæ¥å¤„ç†
  ])
  # ä»¥ä¸Š embedding, éƒ½æ˜¯æå‰è®¡ç®—å¥½çš„. user-towere-Transformer çš„inputé‡Œæ²¡æœ‰ text è¿™ç±»åºåˆ—æ•°æ®.
```

  å¤„ç†æµç¨‹:
  # 1. å°†ç”¨æˆ·ç‰¹å¾å’Œå†å²æ‹¼æ¥
  
  embeddings = [user_embedding, history_embeddings]  # [B, 1+S, D]

  # 2. é€šè¿‡ Transformer ç¼–ç 
  
  model_output = transformer(embeddings)  # [B, 1+S, D]

  # 3. å¹³å‡æ± åŒ–å¾—åˆ°ç”¨æˆ·è¡¨ç¤º
  
  user_representation = mean_pooling(model_output)  # [B, D]

  # 4. L2 å½’ä¸€åŒ–
  
  user_representation = L2_normalize(user_representation)  # [B, D]

  è¾“å‡º: å½’ä¸€åŒ–çš„ç”¨æˆ· embedding [B, D]


  2ï¸âƒ£ Candidate Towerï¼ˆå€™é€‰å¡”ï¼‰- ä¸¤å±‚ MLP

  ä»£ç ä½ç½®: recsys_retrieval_model.py:47-100

  æ¨¡å‹ç±»å‹: Two-Layer MLP (å¤šå±‚æ„ŸçŸ¥æœº)

  æ¶æ„ç»†èŠ‚:

```
  class CandidateTower:
      """
      Input: [B, C, num_hashes * D * 2]  # post + author embeddings æ‹¼æ¥
             â†“
      Layer 1: Linear(input_dim, emb_size * 2) + SiLU
             â†“
      Layer 2: Linear(emb_size * 2, emb_size)
             â†“
      L2 Normalize
             â†“
      Output: [B, C, D]
      """
```

  å…·ä½“ä»£ç :
  
  # ç¬¬ä¸€å±‚ï¼šæŠ•å½±åˆ° 2 å€ emb_size
```
  proj_1 = Linear(input_dim, emb_size * 2)
  hidden = SiLU(proj_1(post_author_embedding))  # [B, C, 2D]
```
  # ç¬¬äºŒå±‚ï¼šæŠ•å½±åˆ° emb_size
```
  proj_2 = Linear(emb_size * 2, emb_size)
  candidate_embeddings = proj_2(hidden)  # [B, C, D]
```
  # L2 å½’ä¸€åŒ–
```
  candidate_representation = L2_normalize(candidate_embeddings)  # [B, C, D]
```

  è¾“å…¥:
```
  post_author_embedding = concat([
      candidate_post_embeddings,   # [B, C, num_item_hashes, D]
      candidate_author_embeddings, # [B, C, num_author_hashes, D]
  ], axis=2)  # [B, C, num_hashes * 2, D]
```

  è¾“å‡º: å½’ä¸€åŒ–çš„å€™é€‰ embedding [B, C, D]


  3ï¸âƒ£ ç›¸ä¼¼åº¦è®¡ç®—ä¸æ£€ç´¢

  ä»£ç ä½ç½®: recsys_retrieval_model.py:346-372

  # 1. è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆç‚¹ç§¯ï¼‰
```
  scores = user_representation @ corpus_embeddings.T  # [B, N]
  # user: [B, D], corpus: [N, D] â†’ scores: [B, N]
```

  # 2. Top-K æ£€ç´¢
```
  top_k_indices, top_k_scores = top_k(scores, k=1000)  # [B, K]
```

  å®Œæ•´çš„æ•°æ®æµ

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    PHOENIX RETRIEVAL SYSTEM                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                     â”‚
  â”‚  INPUT: User + History                    INPUT: All Corpus Posts   â”‚
  â”‚  â”œâ”€ user_hashes: [B, 2]                   â”œâ”€ post_hashes: [N, 2]    â”‚
  â”‚  â”œâ”€ history_post_hashes: [B, S, 2]        â””â”€ author_hashes: [N, 2]  â”‚
  â”‚  â”œâ”€ history_author_hashes: [B, S, 2]                                â”‚
  â”‚  â”œâ”€ history_actions: [B, S, A]                                      â”‚
  â”‚  â””â”€ history_product_surface: [B, S]                                 â”‚
  â”‚          â”‚                                          â”‚               â”‚
  â”‚          â–¼                                          â–¼               â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
  â”‚  â”‚  USER TOWER       â”‚                    â”‚ CANDIDATE TOWER â”‚      â”‚
  â”‚  â”‚  (Transformer)    â”‚                    â”‚  (2-Layer MLP)  â”‚      â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
  â”‚  â”‚ Hash Embeddings   â”‚                    â”‚ Hash Embeddings â”‚      â”‚
  â”‚  â”‚      â†“            â”‚                    â”‚       â†“         â”‚      â”‚
  â”‚  â”‚ Concatenate       â”‚                    â”‚ Concatenate     â”‚      â”‚
  â”‚  â”‚ [user, history]   â”‚                    â”‚ [post, author]  â”‚      â”‚
  â”‚  â”‚      â†“            â”‚                    â”‚       â†“         â”‚      â”‚
  â”‚  â”‚ Transformer       â”‚                    â”‚ Linear + SiLU   â”‚      â”‚
  â”‚  â”‚ - 2 Layers        â”‚                    â”‚       â†“         â”‚      â”‚
  â”‚  â”‚ - MHA + RoPE      â”‚                    â”‚ Linear          â”‚      â”‚
  â”‚  â”‚ - RMSNorm         â”‚                    â”‚       â†“         â”‚      â”‚
  â”‚  â”‚ - SwiGLU FFN      â”‚                    â”‚ L2 Normalize    â”‚      â”‚
  â”‚  â”‚      â†“            â”‚                    â”‚                 â”‚      â”‚
  â”‚  â”‚ Mean Pooling      â”‚                    â”‚                 â”‚      â”‚
  â”‚  â”‚      â†“            â”‚                    â”‚                 â”‚      â”‚
  â”‚  â”‚ L2 Normalize      â”‚                    â”‚                 â”‚      â”‚
  â”‚  â”‚      â†“            â”‚                    â”‚       â†“         â”‚      â”‚
  â”‚  â”‚ user_emb [B, D]   â”‚                    â”‚ corpus_emb[N,D] â”‚      â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
  â”‚            â”‚                                       â”‚                â”‚
  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
  â”‚                           â–¼                                         â”‚
  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
  â”‚                  â”‚  DOT PRODUCT    â”‚                                â”‚
  â”‚                  â”‚  user @ corpus.Tâ”‚                                â”‚
  â”‚                  â”‚   = scores      â”‚                                â”‚
  â”‚                  â”‚   [B, N]        â”‚                                â”‚
  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
  â”‚                           â–¼                                         â”‚
  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
  â”‚                  â”‚   TOP-K         â”‚                                â”‚
  â”‚                  â”‚   k=1000        â”‚                                â”‚
  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
  â”‚                           â–¼                                         â”‚
  â”‚  OUTPUT:                                                            â”‚
  â”‚  â”œâ”€ top_k_indices: [B, K]  - æ¨æ–‡ID                                  â”‚
  â”‚  â”œâ”€ top_k_scores: [B, K]   - ç›¸ä¼¼åº¦åˆ†æ•°                               â”‚
  â”‚  â””â”€ user_representation: [B, D]                                     â”‚
  â”‚                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

  å…³é”®è®¾è®¡ç‰¹ç‚¹

  1. ä¸å¯¹ç§°æ¶æ„

  - User Tower: é‡å‹æ¨¡å‹ï¼ˆTransformerï¼‰- å› ä¸ºéœ€è¦ç†è§£å¤æ‚çš„ç”¨æˆ·è¡Œä¸ºæ¨¡å¼
  - Candidate Tower: è½»é‡çº§æ¨¡å‹ï¼ˆMLPï¼‰- å› ä¸ºéœ€è¦ä¸ºæµ·é‡æ¨æ–‡ç”Ÿæˆ embedding

  2. å…±äº« Transformer æ¶æ„

  ä»£ç æ³¨é‡Šæ˜ç¡®æŒ‡å‡ºï¼ˆrecsys_retrieval_model.py:106-107ï¼‰:
> "This model uses the same transformer architecture as the Phoenix ranker for encoding user representations."

  User Tower ä½¿ç”¨ä¸ Phoenix Ranker ç›¸åŒçš„ Transformer æ¶æ„ã€‚

  3. Hash-based Embeddings

  ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å‡å°‘ embedding table å¤§å°:
```
  HashConfig(
      num_user_hashes=2,    # æ¯ä¸ªç”¨æˆ·ç”¨2ä¸ªå“ˆå¸Œå‡½æ•°
      num_item_hashes=2,    # æ¯æ¡æ¨æ–‡ç”¨2ä¸ªå“ˆå¸Œå‡½æ•°
      num_author_hashes=2,  # æ¯ä¸ªä½œè€…ç”¨2ä¸ªå“ˆå¸Œå‡½æ•°
  )
```

  4. L2 å½’ä¸€åŒ–

  ä¸¤ä¸ªå¡”çš„è¾“å‡ºéƒ½è¿›è¡Œ L2 å½’ä¸€åŒ–ï¼Œä½¿å¾—ç‚¹ç§¯ç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼Œé€‚åˆ ANN æ£€ç´¢ã€‚


  æ¨¡å‹è§„æ¨¡å¯¹æ¯”

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚      é…ç½®        â”‚ Demo (run_retrieval.py) â”‚ ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨æµ‹ï¼‰   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ emb_size        â”‚ 128                     â”‚ 512-1024         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ num_layers      â”‚ 2                       â”‚ 8-16             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ num_q_heads     â”‚ 2                       â”‚ 16-32            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ history_seq_len â”‚ 32                      â”‚ 128-256          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ corpus_size     â”‚ 1000 (demo)             â”‚ æ•°ç™¾ä¸‡-æ•°äº¿       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

  è¿™å°±æ˜¯ Phoenix åŒå¡”æ¨¡å‹çš„å®Œæ•´æ¶æ„ï¼User Tower ç”¨ Transformer æ·±åº¦ç†è§£ç”¨æˆ·ï¼ŒCandidate Tower ç”¨ MLP å¿«é€Ÿç¼–ç æ¨æ–‡ã€‚

